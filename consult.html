<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>상담자 모드 - Body Filler MasterLab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #050506;
      --bg-elevated: #101014;
      --accent: #F4C7B9;
      --accent-soft: rgba(244, 199, 185, 0.12);
      --accent-border: rgba(244, 199, 185, 0.45);
      --text-main: #F9E6DF;
      --text-sub: #B7A7A0;
      --chip-bg: #14141A;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #24151a 0, #050506 55%);
      color: var(--text-main);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 16px 18px;
      border-bottom: 1px solid rgba(244,199,185,0.18);
      background: rgba(5,5,6,0.98);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .back-btn {
      cursor: pointer;
      font-size: 20px;
    }

    .header-title {
      font-size: 15px;
      font-weight: 500;
    }

    main {
      padding: 16px 18px 110px;
      max-width: 820px;
      margin: 0 auto;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-top: 14px;
      margin-bottom: 6px;
    }

    .section-sub {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .cat-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      margin-bottom: 4px;
    }

    @media (min-width: 720px) {
      .cat-grid {
        grid-template-columns: repeat(4, minmax(0,1fr));
      }
    }

    .cat-chip {
      padding: 8px 8px 9px;
      border-radius: 12px;
      background: var(--chip-bg);
      border: 1px solid rgba(244,199,185,0.25);
      font-size: 12px;
      text-align: center;
      cursor: pointer;
      transition: all .16s ease-out;
      color: var(--text-sub);
    }

    .cat-chip.selected {
      background: var(--accent);
      color: #111;
      border-color: rgba(255,255,255,0.7);
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      font-weight: 600;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid rgba(244,199,185,0.28);
      background: rgba(4,4,6,0.92);
      color: var(--text-main);
      font-size: 13px;
      resize: vertical;
      outline: none;
    }

    textarea::placeholder {
      color: rgba(183,167,160,0.7);
    }

    .change-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .change-pill {
      flex: 1 1 30%;
      min-width: 100px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(244,199,185,0.30);
      font-size: 12px;
      text-align: center;
      cursor: pointer;
      color: var(--text-sub);
      background: rgba(10,10,12,0.9);
    }

    .change-pill.selected {
      background: var(--accent);
      color: #111;
      border-color: rgba(255,255,255,0.75);
      font-weight: 600;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--text-sub);
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      accent-color: var(--accent);
    }

    .file-input {
      width: 100%;
      border-radius: 10px;
      border: 1px dashed rgba(244,199,185,0.35);
      background: rgba(10,10,12,0.85);
      padding: 10px;
      font-size: 12px;
      color: var(--text-sub);
    }

    .file-input input {
      margin-top: 6px;
      width: 100%;
    }

    .submit-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 12px 18px 16px;
      background: linear-gradient(to top, rgba(5,5,6,0.98), rgba(5,5,6,0.75));
      border-top: 1px solid rgba(244,199,185,0.28);
    }

    .submit-btn {
      width: 100%;
      border: none;
      border-radius: 999px;
      background: var(--accent);
      color: #111;
      padding: 14px 0;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .submit-note {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-sub);
    }

    .status-msg {
      margin-top: 6px;
      font-size: 11px;
      color: var(--accent);
    }

  </style>
</head>
<body>

<header>
  <div class="back-btn" onclick="goBack()">←</div>
  <div class="header-title">상담자 모드 · 바디 필러 상담</div>
</header>

<main>
  <section>
    <div class="section-title">1. 어느 부위가 가장 고민이세요?</div>
    <div class="section-sub">머리부터 발끝까지, 한 부위를 먼저 선택해주세요. 이후 닥터K가 전체 실루엣을 함께 보면서 설명해 줍니다.</div>

    <div class="cat-grid" id="catGrid"></div>
  </section>

  <section>
    <div class="section-title">2. 지금 제일 거슬리는 부분</div>
    <div class="section-sub">거울이나 사진에서 어떤 느낌이 제일 신경 쓰이는지, 편하게 적어주세요.</div>
    <textarea id="concern" placeholder="예) 골반이 좁아서 전체 비율이 답답해 보이고, 힙딥 때문에 레깅스핏이 마음에 안 들어요."></textarea>
  </section>

  <section>
    <div class="section-title">3. 바뀌었으면 하는 느낌·이미지</div>
    <div class="section-sub">원하는 분위기, 셀럽, 워너비 사진 느낌이 있다면 자유롭게 적어주세요.</div>
    <textarea id="desired" placeholder="예) 골반은 살짝 넓어지고, 힙은 자연스럽게 둥근 볼륨. 과한 글래머보단 자연스럽게 비율 좋아 보이는 느낌."></textarea>
  </section>

  <section>
    <div class="section-title">4. 변화 정도</div>
    <div class="section-sub">이번 1차 시술에서 어느 정도까지 변화를 보고 싶은지 선택해주세요.</div>
    <div class="change-row">
      <div class="change-pill" data-key="light">티 거의 안 나게</div>
      <div class="change-pill" data-key="standard">사진에서 딱 보이게</div>
      <div class="change-pill" data-key="full">이미지 체인지급</div>
    </div>
  </section>

  <section>
    <div class="section-title">5. 시술 · 수술 과거력</div>
    <div class="section-sub">해당되는 항목만 체크해 주세요. 정확할수록 상담이 디테일해집니다.</div>
    <div class="checkbox-group">
      <label><input type="checkbox" value="가슴보형물">가슴보형물 삽입</label>
      <label><input type="checkbox" value="힙보형물">힙보형물 삽입</label>
      <label><input type="checkbox" value="지방흡입">지방흡입</label>
      <label><input type="checkbox" value="지방이식">지방이식</label>
      <label><input type="checkbox" value="영구필러">영구필러 주입</label>
      <label><input type="checkbox" value="히알루론산필러">히알루론산 필러 주입</label>
    </div>
    <textarea id="historyExtra" style="margin-top:8px;" placeholder="기타 과거력, 흉터, 교정 중인 부분 등이 있다면 적어주세요. (선택사항)"></textarea>
  </section>

  <section>
    <div class="section-title">6. 현재 바디 사진 업로드</div>
    <div class="section-sub">정면 / 45도 / 옆 / 후면 등을 3~6장 정도 첨부해주시면 좋아요. 얼굴은 잘려 있어도 괜찮습니다.</div>
    <div class="file-input">
      <div>정면/측면/후면 사진 · 영상 (최대 10개)</div>
      <input id="bodyFiles" type="file" accept="image/*,video/*" multiple />
    </div>
  </section>

  <section>
    <div class="section-title">7. 참고 워너비 사진 (선택)</div>
    <div class="section-sub">인스타·핀터레스트 전후사진, 셀럽 바디라인 등 참고했으면 하는 이미지를 업로드해주세요.</div>
    <div class="file-input">
      <div>워너비/레퍼런스 사진</div>
      <input id="refFiles" type="file" accept="image/*" multiple />
    </div>
  </section>

  <div class="status-msg" id="status"></div>
</main>

<div class="submit-bar">
  <button class="submit-btn" id="submitBtn">닥터K에게 상담 보내기</button>
  <div class="submit-note">※ 실시간 채팅이 아니며, 접수 순서대로 닥터K가 직접 답변드립니다.</div>
</div>

<script>
  const SUPABASE_URL = "https://mljhxswtlahjqexlxlwh.supabase.co";
  const SUPABASE_KEY = "sb_publishable_zhjzgeDAxcImr4july-7Pw_2h2DQAc3";
  const STORAGE_BUCKET = "drk-photos";

  const { createClient } = supabase;
  const client = createClient(SUPABASE_URL, SUPABASE_KEY);

  const CATEGORIES = [
    "정수리","뒤통수","귀전체","귓볼",
    "어깨","근육형 어깨",
    "이두","삼두","전완근","팔꿈치 주름",
    "골반(정면)","힙딥","힙전체",
    "허벅지 필러","허벅지 내외측",
    "무릎내측","무릎주름",
    "종아리","발목필러","발등",
    "기타"
  ];

  const catGrid = document.getElementById("catGrid");
  let selectedPart = "";

  function buildCategories() {
    CATEGORIES.forEach(name => {
      const div = document.createElement("div");
      div.className = "cat-chip";
      div.innerText = name;
      div.addEventListener("click", () => {
        selectedPart = name;
        document.querySelectorAll(".cat-chip").forEach(c => c.classList.remove("selected"));
        div.classList.add("selected");
      });
      catGrid.appendChild(div);
    });

    const urlParams = new URLSearchParams(window.location.search);
    const preset = urlParams.get("part");
    if (preset && CATEGORIES.includes(preset)) {
      const chip = Array.from(document.querySelectorAll(".cat-chip")).find(c => c.innerText === preset);
      if (chip) {
        chip.classList.add("selected");
        selectedPart = preset;
      }
    }
  }

  buildCategories();

  let changeLevel = "";
  document.querySelectorAll(".change-pill").forEach(pill => {
    pill.addEventListener("click", () => {
      changeLevel = pill.dataset.key;
      document.querySelectorAll(".change-pill").forEach(p => p.classList.remove("selected"));
      pill.classList.add("selected");
    });
  });

  function goBack() {
    if (document.referrer) {
      history.back();
    } else {
      window.location.href = "index.html";
    }
  }

  async function uploadFiles(caseId, type, fileList) {
    const urls = [];
    for (let i = 0; i < fileList.length; i++) {
      const f = fileList[i];
      const path = `${caseId}/${type}-${Date.now()}-${i}-${f.name}`;
      const { data, error } = await client.storage
        .from(STORAGE_BUCKET)
        .upload(path, f);

      if (error) {
        console.error("upload error", error);
        continue;
      }

      const { data: pub } = client.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      const publicUrl = pub.publicUrl;

      await client.from("photos").insert({
        case_id: caseId,
        type: type,
        url: publicUrl
      });

      urls.push(publicUrl);
    }
    return urls;
  }

  const statusEl = document.getElementById("status");
  const submitBtn = document.getElementById("submitBtn");

  submitBtn.addEventListener("click", async () => {
    try {
      statusEl.textContent = "";

      if (!selectedPart) {
        alert("어디가 가장 고민인지 한 부위를 선택해주세요.");
        return;
      }

      const concern = document.getElementById("concern").value.trim();
      if (!concern) {
        alert("지금 제일 고민되는 부분을 한 줄 이상 적어주세요.");
        return;
      }

      const desired = document.getElementById("desired").value.trim();
      const historyChecked = Array.from(document.querySelectorAll(".checkbox-group input:checked"))
        .map(c => c.value);
      const historyExtra = document.getElementById("historyExtra").value.trim();
      const history = [...historyChecked, historyExtra].filter(Boolean).join(" / ");

      statusEl.textContent = "상담을 저장하는 중입니다. 잠시만 기다려주세요...";

      const { data: caseData, error: caseErr } = await client
        .from("cases")
        .insert({
          part: selectedPart,
          partGroup: "Body",
          concern,
          desired,
          changeLevel: changeLevel || null,
          history,
          status: "new"
        })
        .select("*")
        .single();

      if (caseErr) {
        console.error(caseErr);
        alert("상담 저장 중 문제가 발생했습니다. 잠시 후 다시 시도해주세요.");
        statusEl.textContent = "";
        return;
      }

      const caseId = caseData.id;

      const bodyFiles = document.getElementById("bodyFiles").files;
      const refFiles = document.getElementById("refFiles").files;

      if (bodyFiles.length > 0) {
        await uploadFiles(caseId, "body", bodyFiles);
      }
      if (refFiles.length > 0) {
        await uploadFiles(caseId, "ref", refFiles);
      }

      const firstMessageText =
        `부위: ${selectedPart}\n` +
        (concern ? `고민: ${concern}\n` : "") +
        (desired ? `원하는 이미지: ${desired}\n` : "") +
        (changeLevel ? `변화 정도: ${changeLevel}\n` : "") +
        (history ? `시술/수술 과거력: ${history}` : "");

      await client.from("messages").insert({
        case_id: caseId,
        from: "user",
        text: firstMessageText
      });

      statusEl.textContent = "상담 접수가 완료되었습니다.";
      window.location.href = "success.html";
    } catch (e) {
      console.error(e);
      alert("알 수 없는 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
      statusEl.textContent = "";
    }
  });
</script>
</body>
</html>
